name: Backend Lint & Type Check

on:
  pull_request:
    branches: [ '*' ]
    paths: 
      - 'backend/**'
      - '.github/workflows/backend-lint.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  lint:
    name: Backend Linting & Type Checking
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: read
    
    defaults:
      run:
        working-directory: backend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run ruff check
      id: ruff_check
      run: |
        echo "Running ruff check..."
        if ruff check . --output-format=json > ruff-check-output.json 2>&1; then
          echo "RUFF_CHECK_PASSED=true" >> $GITHUB_ENV
          echo "‚úÖ No ruff check errors found!"
        else
          echo "RUFF_CHECK_PASSED=false" >> $GITHUB_ENV
          echo "‚ö†Ô∏è Ruff check found issues!"
          # Also save human-readable output
          ruff check . > ruff-check-human.txt 2>&1 || true
        fi
      continue-on-error: true
    
    - name: Run mypy
      id: mypy
      run: |
        echo "Running mypy..."
        if mypy . > mypy-output.txt 2>&1; then
          echo "MYPY_PASSED=true" >> $GITHUB_ENV
          echo "‚úÖ No mypy errors found"
        else
          echo "MYPY_PASSED=false" >> $GITHUB_ENV
          echo "‚ö†Ô∏è Mypy found type issues"
        fi
        cat mypy-output.txt
      continue-on-error: true
    
    - name: Create Lint Summary
      id: create_summary
      if: github.event_name == 'pull_request'
      run: |
        {
          echo '## üîç Backend Lint & Type Check Results'
          echo ''
          
          # Ruff Check Status
          if [[ "${{ env.RUFF_CHECK_PASSED }}" == "true" ]]; then
            echo '### ‚úÖ Ruff Check: **Passed**'
            echo 'No linting issues found.'
          else
            echo '### ‚ö†Ô∏è Ruff Check: **Issues Found**'
            echo '<details><summary>View ruff check output</summary>'
            echo ''
            echo '```'
            head -100 ruff-check-human.txt 2>/dev/null || echo "No detailed output available"
            echo '```'
            echo '</details>'
          fi
          echo ''
          
          # Ruff Format Status
          if [[ "${{ env.RUFF_FORMAT_PASSED }}" == "true" ]]; then
            echo '### ‚úÖ Ruff Format: **Passed**'
            echo 'Code is properly formatted.'
          else
            echo '### ‚ö†Ô∏è Ruff Format: **Issues Found**'
            echo '<details><summary>View formatting issues</summary>'
            echo ''
            echo '```'
            head -100 ruff-format-output.txt
            echo '```'
            echo '</details>'
            echo ''
            echo '**Fix with:** `ruff format .` in the backend directory'
          fi
          echo ''
          
          # Mypy Status
          if [[ "${{ env.MYPY_PASSED }}" == "true" ]]; then
            echo '### ‚úÖ MyPy: **Passed**'
            echo 'No type checking issues found.'
          else
            echo '### ‚ö†Ô∏è MyPy: **Type Issues Found**'
            echo '<details><summary>View mypy output</summary>'
            echo ''
            echo '```'
            head -100 mypy-output.txt
            echo '```'
            echo '</details>'
          fi
          echo ''
          
          # Overall Summary
          if [[ "${{ env.RUFF_CHECK_PASSED }}" == "true" ]] && [[ "${{ env.RUFF_FORMAT_PASSED }}" == "true" ]] && [[ "${{ env.MYPY_PASSED }}" == "true" ]]; then
            echo '---'
            echo '### üéâ All backend checks passed!'
            echo ''
            echo 'Your backend code is clean, well-formatted, and type-safe! üëª'
          else
            echo '---'
            echo '### üìã Action Required'
            echo ''
            echo 'Please review and fix the issues above before merging.'
            echo ''
            echo '**Quick fixes:**'
            echo '- Run `ruff check --fix .` to auto-fix linting issues'
            echo '- Run `ruff format .` to format your code'
            echo '- Fix type annotations for mypy errors'
          fi
          echo ''
          echo '<!-- backend-lint-check-comment-marker -->'
        } > ../backend-lint-report.md
        
    - name: Post PR Comment
      if: github.event_name == 'pull_request'
      uses: peter-evans/create-or-update-comment@v4
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body-path: backend-lint-report.md
        comment-marker: backend-lint-check-comment-marker
